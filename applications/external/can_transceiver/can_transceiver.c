// Main code.

// FYI: I'm new to making apps for the Flipper Zero, so expect a ton of comments.
// I also used the SPI Mem Manager app massively for reference, which is in the "flipperzero-good-faps" repo:
//	https://github.com/flipperdevices/flipperzero-good-faps
// Lots of credit goes to DrunkBatya, as well as original app devs Hedger, ghettoforce, and x893.
// I'll try my best not to shamelessly plagiarize, but the app code does so much well (by my standards) that it's hard not to.

// ==== INCLUDES ====

#include "can_transceiver.h"

/* generated by fbt from .png files in images folder */
#include <can_transceiver_icons.h>


// ==== HANDLERS AND CALLBACKS ====

static bool CANTransceiver_CustomEventCallback(void* pContext, uint32_t u32Event)
{
	CANTransceiverGlobals* pInstance;

	ASSERT(pContext);

	pInstance = (CANTransceiverGlobals*)pContext;
	return scene_manager_handle_custom_event(pInstance->pSceneManager, u32Event);
}

static bool CANTransceiver_BackEventCallback(void* pContext)
{
	CANTransceiverGlobals* pInstance;

	ASSERT(pContext);

	pInstance = (CANTransceiverGlobals*)pContext;
	return scene_manager_handle_back_event(pInstance->pSceneManager);
}


// ==== FUNCTIONS ====

// Allocate the instance struct and all globals in it.
CANTransceiverGlobals* CANTransceiver_Constructor(void)
{
	CANTransceiverGlobals* pInstance = malloc(sizeof(CANTransceiverGlobals));
	memset(pInstance, 0, sizeof(CANTransceiverGlobals));

	// Non-GUI-related globals.
	pInstance->pMCP2515Worker = MCP2515Worker_Alloc();
	pInstance->pRxHistory = CANTransceiver_RxHistory_Alloc();

	// Open records.
	pInstance->pGUI = furi_record_open(RECORD_GUI);
	pInstance->pFSApi = furi_record_open(RECORD_STORAGE);

	// Allocate GUI controllers and elements.
	pInstance->pViewDispatcher = view_dispatcher_alloc();
	pInstance->pSceneManager = scene_manager_alloc(&CANTransceiver_Scene_Handlers, pInstance);
	pInstance->pSubmenu = submenu_alloc();
	pInstance->pWidget = widget_alloc();
	pInstance->pVarItemList = variable_item_list_alloc();
	pInstance->pViewCANRx = CANTransceiver_ViewCANRx_Alloc();
	pInstance->pViewCANTx = CANTransceiver_ViewCANTx_Alloc();
	pInstance->pByteInput = byte_input_alloc();
	pInstance->pTextInput = text_input_alloc();
	// TODO as needed

	// Configure the view dispatcher.
	view_dispatcher_enable_queue(pInstance->pViewDispatcher);
	view_dispatcher_set_event_callback_context(pInstance->pViewDispatcher, pInstance);
	view_dispatcher_set_custom_event_callback(pInstance->pViewDispatcher, CANTransceiver_CustomEventCallback);
	view_dispatcher_set_navigation_event_callback(pInstance->pViewDispatcher, CANTransceiver_BackEventCallback);
	view_dispatcher_attach_to_gui(pInstance->pViewDispatcher, pInstance->pGUI, ViewDispatcherTypeFullscreen);

	// Add views to the view dispatcher.
	view_dispatcher_add_view(pInstance->pViewDispatcher, CANTransceiverViewSubmenu, submenu_get_view(pInstance->pSubmenu));
	view_dispatcher_add_view(pInstance->pViewDispatcher, CANTransceiverViewWidget, widget_get_view(pInstance->pWidget));
	view_dispatcher_add_view(pInstance->pViewDispatcher, CANTransceiverViewVariableItemList,
		variable_item_list_get_view(pInstance->pVarItemList));
	view_dispatcher_add_view(pInstance->pViewDispatcher, CANTransceiverViewCANRx,
		CANTransceiver_ViewCANRx_GetView(pInstance->pViewCANRx));
	view_dispatcher_add_view(pInstance->pViewDispatcher, CANTransceiverViewCANTx,
		CANTransceiver_ViewCANTx_GetView(pInstance->pViewCANTx));
	view_dispatcher_add_view(pInstance->pViewDispatcher, CANTransceiverViewByteInput, byte_input_get_view(pInstance->pByteInput));
	view_dispatcher_add_view(pInstance->pViewDispatcher, CANTransceiverViewTextInput, text_input_get_view(pInstance->pTextInput));
	// TODO as needed

	// Other configurations.
	furi_hal_power_enable_otg();
	furi_hal_spi_bus_handle_init(&furi_hal_spi_bus_handle_external);
	// FIXME: SPI bus is quite slow - about 2-3 MHz. Should speed it up to roughly 10 MHz, the MCP2515's limit.

	// Set the default app config.
	pInstance->pGlobalConfig = CANTransceiver_GlobalConf_Create();

	return pInstance;
}

// Cleans up the app instance.
void CANTransceiver_Destroyer(CANTransceiverGlobals* pInstance)
{
	// Non-GUI globals to free.
	CANTransceiver_RxHistory_Free(pInstance->pRxHistory);
	MCP2515Worker_Free(pInstance->pMCP2515Worker);

	// Remove views from the view dispatcher.
	// TODO as needed
	view_dispatcher_remove_view(pInstance->pViewDispatcher, CANTransceiverViewTextInput);
	view_dispatcher_remove_view(pInstance->pViewDispatcher, CANTransceiverViewByteInput);
	view_dispatcher_remove_view(pInstance->pViewDispatcher, CANTransceiverViewCANTx);
	view_dispatcher_remove_view(pInstance->pViewDispatcher, CANTransceiverViewCANRx);
	view_dispatcher_remove_view(pInstance->pViewDispatcher, CANTransceiverViewVariableItemList);
	view_dispatcher_remove_view(pInstance->pViewDispatcher, CANTransceiverViewWidget);
	view_dispatcher_remove_view(pInstance->pViewDispatcher, CANTransceiverViewSubmenu);

	// Free GUI elements.
	// TODO as needed
	text_input_free(pInstance->pTextInput);
	byte_input_free(pInstance->pByteInput);
	CANTransceiver_ViewCANTx_Free(pInstance->pViewCANTx);
	CANTransceiver_ViewCANRx_Free(pInstance->pViewCANRx);
	variable_item_list_free(pInstance->pVarItemList);
	widget_free(pInstance->pWidget);
	submenu_free(pInstance->pSubmenu);
	scene_manager_free(pInstance->pSceneManager);
	view_dispatcher_free(pInstance->pViewDispatcher);

	// Free any other malloc'd globals.
	CANTransceiver_GlobalConf_Free(pInstance->pGlobalConfig);

	// Close all opened records.
	furi_record_close(RECORD_STORAGE);
	furi_record_close(RECORD_GUI);

	// Undo other configurations done in CANTransceiver_Constructor.
	furi_hal_spi_bus_handle_deinit(&furi_hal_spi_bus_handle_external);
	furi_hal_power_disable_otg();

	free(pInstance);
}


// ==== MAIN CODE ====

int32_t CANTransceiver_Main(void* p)
{
	CANTransceiverGlobals* pInstance;

	UNUSED(p);
	FURI_LOG_I("CAN-Transceiver", "APP STARTING");

	pInstance = CANTransceiver_Constructor();
	scene_manager_next_scene(pInstance->pSceneManager, CANTransceiver_SceneMainMenu);
	view_dispatcher_run(pInstance->pViewDispatcher);
	CANTransceiver_Destroyer(pInstance);

	FURI_LOG_I("CAN-Transceiver", "APP EXITING");
	return 0;
}
