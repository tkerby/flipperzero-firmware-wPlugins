# 卡片数据格式说明

以下协议符合 EMV 标准以及交通运输部 JT/T 978 标准

## 读卡内余额

指令:

| 命令字 | 值   | 备注 |
| ------ | ---- | ---- |
| CLA    | 0x80 |      |
| INS    | 0x5C |      |
| P1     | 0x00 |      |
| P2     | 0x02 |      |
| Lc     | -    |      |
| Data   | -    |      |
| Le     | 0x04 |      |

响应 APDU:

| 偏移 | 含义 | 长度 | 格式 | 备注                     |
| ---- | ---- | ---- | ---- | ------------------------ |
| 0x00 | 余额 | 4    | BIN  | 大端序 uint16 单位为“分” |

eg:

> PCD->PICC: 80 5C 00 02 04
>
> PICC->PCD: 00 00 0A C3 90 00

## 读线性记录

指令:

| 命令字 | 值       | 备注               |
| ------ | -------- | ------------------ |
| CLA    | 0x00     |                    |
| INS    | 0xB2     |                    |
| P1     | 记录号   |                    |
| P2     | 控制参数 | (SFI << 3) \| 0x04 |
| Lc     | -        |                    |
| Data   | -        |                    |
| Le     | 0x00     |                    |

### SFI 0x18 交易记录

响应 APDU:

| 偏移 | 含义     | 长度 | 格式 | 备注                                             |
| ---- | -------- | ---- | ---- | ------------------------------------------------ |
| 0x00 | 交易序号 | 2    | BIN  | 大端序 uint16                                    |
| 0x02 | 保留     | 3    | -    |                                                  |
| 0x05 | 交易金额 | 4    | BIN  | 大端序 uint32 单位为“分”                         |
| 0x09 | 交易类型 | 1    | BIN  | 0x02: 充值</br>0x06: 单次消费</br>0x09: 复合消费 |
| 0x0A | 终端号   | 6    | BCD  |                                                  |
| 0x10 | 时间戳   | 7    | BCD  | YYYYMMDDhhmmss                                   |

eg:

> PCD->PICC: 00 b2 01 c4 00
>
> PICC->PCD: 04 2d 00 00 00 00 00 01 f4 09 30 00 89 00 03 40 20 24 12 29 14 17 40 90 00

### SFI 0x1E 行程记录

响应 APDU:

| 偏移 | 含义       | 长度 | 格式 | 备注                                                    |
| ---- | ---------- | ---- | ---- | ------------------------------------------------------- |
| 0x00 | 交易类型   | 1    | BCD  | 0x02: 单次</br>0x03: 进站</br>0x04: 出站</br>0x06: 单次 |
| 0x01 | 终端号     | 8    | BCD  |                                                         |
| 0x09 | 辅助类型   | 1    | BCD  | 0x00: 其他</br>0x01: 地铁</br>0x02: 公交                |
| 0x0A | 线路和站点 | 7    | BCD  |                                                         |
| 0x11 | 交易金额   | 4    | BIN  | 大端序 uint32 单位为“分”                                |
| 0x15 | 余额       | 4    | BIN  | 大端序 uint32 单位为“分”                                |
| 0x19 | 时间戳     | 7    | BCD  | YYYYMMDDhhmmss                                          |
| 0x20 | 城市       | 2    | BCD  |                                                         |
| 0x22 | 收单机构   | 8    | BCD  |                                                         |
| 0x2A | 保留       | 6    | -    | 0x00                                                    |

eg:

> PCD->PICC: 00 b2 01 f4 00
>
> PICC->PCD: 04 00 00 30 00 89 00 03 40 01 08 00 19 00 30 00 00 00 00 01 f4 00 00 0e 01 20 24 12 29 14 17 40 10 00 01 01 10 00 ff ff ff ff 00 00 00 00 00 00 90 00
